#include "ppu.h"
#include "level.h"

#define MAPLEN 240

static const u8 tiletable[] =
{
  0, 0, 0, 0,             /* empty  0x0 */
  0x1, 0x1, 0x2, 0x2,     /* brick  0x1 */
  0xA, 0xB, 0xA, 0xB,     /* ladder 0x2 */
  0xC, 0xD, 0xE, 0xF,     /* key    0x3 */
  0x10, 0x11, 0x12, 0x13, /* lock   0x4 */
  0x6, 0x7, 0x8, 0x9,     /* door   0x5 */
};

static const u8 level_1[] =
{
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x05, 0x04, 0x02, 0x00, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x01, 0x01, 0x02, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x00, 0x00, 0x01, 0x01,
  0x01, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x01, 0x01, 0x01,
  0x01, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x01, 0x01, 0x01,
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static const u8* level_table[] = { level_1 };

const u8* tilemap;

static void __fastcall__ load_tilemap(void)
{
  u8 loop;
  u8 tile_index;
  u8 col_cnt;

  u16 offset = 0;
  u16 base_address = 0x2000;
  u16 address;

  col_cnt = 0;

  for (loop = 0; loop < MAPLEN; loop++)
  {
    tile_index = tilemap[loop];

    /* Multpliy by 4 to get index in tiletable. */
    tile_index = tile_index << 2;

    address = base_address + offset;

    ppuwrite(address, tiletable[tile_index+0]);
    ppuwrite(address+1, tiletable[tile_index+1]);
    ppuwrite(address+32, tiletable[tile_index+2]);
    ppuwrite(address+33, tiletable[tile_index+3]);

    col_cnt++;

    if (col_cnt == 16)
    {
      col_cnt = 0;
      offset += 34;
    }
    else
    {
      offset += 2;
    }
  }
}

void __fastcall__ load_level(u8 number)
{
  tilemap = level_table[number];

  load_tilemap();
}
